# はじめに
Twitterの動乱に巻き込まれ、移住先にMisskeyやMastodonなど選ばれつつある今日このごろ、皆様いかがお過ごしでしょうか。

つい先日、BlueSkyのクローズドベータが開始されました。
BlueSkyは、Nostr同様Twitter創設者のジャック・ドーシー氏の支援の元開発されている新しいSNSです。

Mastodon等のActivityPubにおける弱点を解決しようと開発されているものです。
Nostr開発者たちがこぞって注目している現在、私の理解している限りの説明を書いてみようと思います。

ATコマンドではないですよ

**※現在クローズドβ中です。アカウント作成には、開発者から発行される招待コードが必要です。**

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/72b24b1e-8e8e-c254-4203-7743d79f5524.png)

# 注意
いろいろな意味でにわかユーザーが書いてますので、原典を当たってください。間違いがあれば編集リクエストをください。

https://atproto.com/

https://www.w3.org/TR/did-core/

http://www.asahi-net.or.jp/~ax2s-KMTN/internet/did/REC-did-core-20220719.html

何がいいのかとか、そういった話は以下の記事のようにブロガーの人たちがたくさん書くと思うので、本記事では技術的な側面にフォーカスして書きます。

https://netafull.net/tech/0126173.html

# 関連情報
公式サイト

https://blueskyweb.xyz/

公式アプリ

https://apps.apple.com/jp/app/bluesky-social/id6444370199

Scrapbox(wiki)

https://scrapbox.io/Bluesky/

非公式ブラウザクライアント

https://penpenpng.github.io/skylight/

https://bsky.syui.cf/

https://blue.amazingca.dev/

↑@gpsnmeajp.bsky.social を入れると私の投稿が見れます。

# 結論
まだMastodon以下の機能実現状況なので、SNS目的で参加するのはNostr以上に勧めしません。

# 特徴と違いについて
まず私の理解を図に表します。

## 中央集権型(Twitterなど)
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/c613df7b-3fd3-aab2-1029-e79a7d5f3ed7.png)

## 連合型分散(地方分権型) (ActivityPubのMastodon, Misskeyなど)
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/38ccc119-fc34-e615-d8a5-ee05dd2261d6.png)

## リレー型分散(無責任中継型) (Nostr)
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/922901ea-4d92-f67c-3f38-ac245a1413c5.png)

https://qiita.com/gpsnmeajp/items/77eee9535fb1a092e286

## AT Protocol(地方分権型 + アカウントポータビリティ)  (ATP:BlueSky)
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/1a9d75da-4f09-1949-10cf-bb3901265da3.png)

# AT Protocol (Authenticated Transfer Protocol) の目指す姿
AT Protocolは、BlueSkyによって作成されたネットワークテクノロジーです。

+ 連合型ソーシャル: AT Protocolを使用している任意のサービス同士でやり取りが可能です。
+ アルゴリズムの選択: オープンマーケットのアルゴリズムを任意に選ぶことで、世界の見え方を選ぶことができます。
+ ポータブルアカウント: コンテンツ・フォロワー・IDを失わずに移動することができます。

## AT Protocolの登場人物(用語集)
### DID/ユーザー識別子 あるいは リポジトリ識別子

+ DID (Decentralized Identifier - 分散識別子/分権識別子/非中央集権型識別子)
W3Cの定義する識別子。AT Protocolではユーザーの **永続的なID** として使用する。リポジトリの識別子でもある。
人や組織、モノやその他なんでも識別したいもの(これをDID Subject(対象?)と言う)に割り振るグローバルにユニーク(唯一性のある)IDだが、従来のIDとは異なり集中管理を前提としていない。
UUIDとは異なり、公開鍵暗号/公開鍵署名の仕組みを用いて検証が可能である。
殆どの場合、分散型台帳技術(DLT:ブロックチェーン等)あるいはその他の分散型ネットワークを使う(AT Protocolのように)。

以下のような形をしている
```
did:example:11111111111111111111111111111
did:メソッド:メソッド特有の識別子
```

以下のような関係性を持つ
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/627031d0-c7e8-88b0-979a-0b67a3707190.png)

https://www.publickey1.jp/blog/22/w3ciddecentralized_identifiers_dids.html

+ DID URL
DIDを含むURLで、DID Subject(対象)の情報や、DID Documentの情報、あるいは関連する外部リソースの情報を指す。クエリを含むこともできる。

+ DID Subject
人や組織、モノやその他なんでも識別したい対象もののこと。DIDが割り振られる対象。
AT Protocolではユーザのこと。
もっと言えば公開鍵で証明されるユーザのこと。

+ DID Document
DID Subjectと他のものの関係性を説明・証明するもの。JSONだったりバイナリだったりする。
有効期間中は1つのDIDを指し続ける。公開鍵やSubjectの認証方法なども提供する。X509証明書に相当する？役割をする。
DID Controllerのみが変更する権限を持つ。

+ DID Controller
DID Documentに変更を加える能力を持つ存在。すなわち、DIDに対する全権利を保持する存在。
1つのDID Documentには複数のDID Controllerが存在しうる。DID Subjectと同一の可能性がある。
AT Protocolにおいては(おそらく)ユーザ自身のこと。
もっと言えば署名キー・回復キーをきちんと管理できているユーザー自身のこと。

+ DID DeleGate
DID Documentにもとづき、DID Controllerによって部分的にDIDに関連づく権限を利用許可(委譲)されている存在。

+ DID resolver / DID resolution
DIDを入力と適切な情報を入力すると、DID Documentと追加データを出力する存在(システム)およびその行為

+ DID URL dereferencer / DID URL dereference
DID URLまたはDID Documentに対して、リソース取得先を出力する存在(システム)およびその行為
リソースとしては、DID Documentと追加データであったり、その他のDID Document内の情報であったり、DID Documentに記載されている外部リソースだったりする．

### AT Protocol (スモールワールド)
+ Handle (DNS Name)
AT Protocol内で使われる分かりやすいサービス固有のユーザー識別子であり、アプリケーションが解決のために最初にアクセスする先となる。
ユーザーを探すのに使用できる分かりやすい識別子である。**永続性はない**。
アプリケーションはここからDIDに解決し、DIDを正規の識別子として使用する。
そしてDIDから公開鍵やDID Documentに解決する。

※ハンドルネームはホスティングサービスに依存するため、引っ越しで変わりうる。
　DIDはポータブルであり引っ越しても変化しない。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/191114/a3e000e8-9c9c-e922-eac5-bf5f8c3931f6.png)

+ did:plc
DIDを公開・解決するためのAT Protocol独自の仕組み。
一時的な仕組みであり、今後数年以内に置き換えられる予定のためPlaceholderという名前がついている。

このDIDの識別子は、署名されたデータリポジトリの最初の操作のSHA256ハッシュのBASE32エンコードの24文字切り捨てであり、つまり生成時から変更を追跡するためのハッシュとなっている。

既存のDID提供方法では目的を達成できないためAT Protocol独自で用意したものであり、DID Documentには最小限かつ独自の要素を含んでいる。

具体的には

```
署名キー
回復キー
ユーザー名
PDSアドレス
```

のみを保持する。

+ did:web
DIDを実用上立ち上げるために、Webドメインの信用を利用したDID提供法およびそれ自体に依るDID。
ホストまたはドメインであり、TLS保護されている必要がある。
/.well-known/did.jsonに配置されたjsonで、DID Documentを提供する。
NostrのNIP-05に似ているがより密に結合されている。

※did:plcと違ってデータリポジトリのハッシュに紐づかないけどどうするんだろう？

https://w3c-ccg.github.io/did-method-web/

+ 署名キー
AT Protocolにて署名されたデータリポジトリに書き込むために必要な秘密鍵。
あるいは、DID Documentそのものへの書き込みに必要な秘密鍵。
Nostrで言えば秘密鍵に相当する。基本的にPDSに委託され、ユーザー自身が持つわけではない。

+ 回復キー
AT Protocolにて署名されたデータリポジトリのDID Documentそのものへの書き込みに使用できる必要な秘密鍵。
署名キーのように使用することはできないが、72時間以内の履歴の上書きという特別な機能を提供する。(MSTの)
これにより、悪意のある管理者や悪意のある人間に署名キーが渡ったときに、キーのローテーションを可能にする。
基本的にPDSに委託されず、ユーザー自身が保持する。(紙などで)

また、これによりPDSがサービスを突然閉じたり凍結したりしても、回復キーで新しくキーを生成し、別のPDSにDID Documentを向け直して(PDSアドレスを書き換えて)更新することで、元のPDSの同意を得ることなく引っ越すことができます。

※現在のBlueSkyには回復キーを取り出す手段がないようにみえる。
※サービスダウン引っ越しの際、新しいDID Documentの場所をフォロワーはどうやって知るのか？Handleは無効になると思う。did:webなら良いが。

+ PDS パーソナルデータサーバー
スモールワールドネットワーキングを実現する要であり、スピーチ層を構成する。
またデータの保存・ユーザーの所属・フェデレーション(連合)の構成を実現する。
Mastodon等でのインスタンスに相当する存在である。
ユーザーの署名秘密鍵を預かる。
投稿や閲覧のためのAPIの提供を行う。
検索はクローリングインデクサーとの仲介で実現する。
データの保存のため、各ユーザごとの署名されたデータリポジトリを内包する。

+ 署名されたデータリポジトリ
Gitのようにハッシュの連鎖で表す決定論的に決まるハッシュ木構造 MST(Merkle Search Trees)によって保存されるデータ集合体。
1ユーザごとに1リポジトリが作成される。did:plcの識別子はこのリポジトリの最初の操作を表すSHA256となっている。
リポジトリにコミットするには署名が必要であり、これがDID Documentの公開鍵に基づくため本人の投稿であることが検証できる。
コミットの際にはルートノードが生成され、それが前のコミットを示すため、更新履歴の連鎖となる。

+ スモールワールドネットワーキング
投稿・メンション・DMなど特定のユーザーレベルの対人アクティビティイベントと、その関係性によるイベント配送

+ スピーチレイヤー
発言層。権限を分散し、誰でも発言できるようにすることを前提とする。

### AT Protocol(ビッグワールド)
+ クローリングインデクサー
大規模統計(いいね数の集計や、再投稿数の集計、フォロワー)、おすすめコンテンツ、おすすめユーザーなどアルゴリズム的選出や、ユーザー検索などを提供する存在。
検索エンジンに相当する。
これらをPDSにやらせると負荷が高いためスケーリングに問題が出る。
また、ユーザーが望まないアルゴリズムが使われているときに逃れられないなどの問題もある。
一方で、ないと非常に不便であり、ユーザーを探すことができなくなる。
そのため、PDSとは切り離した存在とし、別でPDSをクロールさせることで、スケーリングの問題を解消する。
なお、検索インターフェースやフィードはPDSから提供される。

+ アルゴリズム
いわゆるおすすめアルゴリズムや、検索アルゴリズム

+ ビッグワールドネットワーキング
クローリングインデクサーの担当する領域のこと。
複数PDSを横断する大きな領域という意味も持つと思われる。

+ リーチレイヤー
到達層。フレキシぶりでスケーラブルなことを目指している。
キュレーションやモデレーションは現実的に必要になるが、それはスピーチレイヤーとリーチレイヤーの間で行われる想定である。

### AT Protocol
+ NSID (名前空間ID)
AT Protocol全体で、メソッドやレコードタイプ、その他を識別するための名前。
有効なドメイン名を使う必要があり、逆ドメイン名記法で書く。

以下のようになっている

```
com.atproto.account
app.bsky.actor
```

+ Lexicon (辞書, 語彙)
XRPCメソッドとリポジトリレコードタイプを定義するために用いられるJSONスキーマ。
どんな操作ができるか、どんな記録ができるかを定義したものであり、型定義。ある意味でプロトコルそのものの定義。
NSIDで名前がついており、相互運用性を保証する。
AT ProtocolのサイトにもLexiconが掲載されている。

+ bsky.app
アプリケーションセマンティックを担当する。BlueSky(SNS)として機能するための仕様やプロトコル
フィードやフォロー関係性、通知などを定義する。

+ @ Protocol (AT Protocol / Authenticated Transfer Protocol)
コアネットワークを担当する。相互通信を実現するための仕様やプロトコル。
アカウントやデータ保存、同期などを定義する。

+ XRPC
HTTPSの軽いラッパーであり、汎用通信レイヤー。
GET/POSTで通信する。

# AT Protocolの仕組み
TwitterみたいなSNSを作ることを目的としています。
連合分散型(非中央集権/分権型)のサーバー・クライアントモデルです。

Mastodon等でいうところのサーバー(インスタンス)のことを、PDS(個人データストア)と言います。

PDS同士は連合するため、やり取りが可能になることが期待されています。**(未実装)**
連合にはActivityPubの代わりに、ATProtocolが使用されます。
PDSとクライアントの間の通信にも、ATProtocolが使用されます。

ブロックチェーンは使用していません。

## ActivityPubによるFederationと何が違うのか？ (Mastodon、Misskeyとかとの違いは？)
**アカウントポータビリティ**, **スケーラビリティ**　この2点です。

### アカウントポータビリティ

従来のActivityPub連合型のシステムは、分権されていることによって所属の自由が生まれましたが、
サーバーの突然の管理放棄や、ダウン、管理者の方針変更などによってアカウント閉じ込めが発生します。

これが発生してしまうと、Mastodon等ではアカウントやフォロー関係、今までの投稿は捨てることになります。
また、サーバーが生きていれば引っ越し機能が使え、フォロワーを引っ越させることができますが、投稿は移行できません。

また、悪意のある管理者によってアカウントが乗っ取られる可能性もあります。

AT Protocolでは、
+ 永続的なDIDによるフォロー関係の維持 **(未実装?)**
+ 回復キーによるキーローテーション **(未実装?)**
+ クライアントのローカルリポジトリへのバックアップによる投稿含めた引っ越し **(未実装?)**
+ 公開鍵署名による保証

により、これらの問題を解決します。**(未実装?)**

### スケーラビリティとユーザー到達制
AT Protocolではクローリングインデクサーというものが定義されています。

これは、大規模統計(いいね数の集計や、再投稿数の集計、フォロワー)、おすすめコンテンツ、おすすめユーザーなどアルゴリズム的選出や、ユーザー検索などを提供する存在であり、一般的に検索エンジンに相当するものです。

これらをPDSにやらせると負荷が高いためスケーリングに問題が出ます。
また、ユーザーが望まないアルゴリズムが使われているときに逃れられないなどの問題もあります。

一方で、ないと非常に不便であり、ユーザーを探せなかったり、検索がまともに機能しなかったりします。

そのため、PDSとは切り離した存在とし、別でPDSをクロールさせることで、スケーリングの問題を解消しながら到達性を確保しようというものです。**(未実装?)**

なお、検索インターフェースやフィードはPDSから提供されます。**(未実装?)**

## Nostrの何を解決し、何を解決しないのか？
Nostrは、公開鍵対が唯一をユーザー証明とすることで、アカウントのポータビリティを実現しました。
投稿は持ち運べませんが、接続するリレーを切り替えることで、フォロー関係を維持したまま一瞬で引っ越しが完了します。

また、複数のリレーに投稿することで多重化されており、サーバーひとつが落ちてもほとんど影響を受けないような仕組みになっています。
電子署名を使用することで、究極的にサーバーを信用しない仕組みができました。

一方で、

+ リレー一つ一つの責任が軽い
+ データの保持期間が不明確
+ 所属が不明確

など様々な問題点もあります。これらはトレードオフです。

AT Protcolでは、公開鍵対によってポータビリティを実現する機能と、Mastodon同様のサーバー所有によるデータ保持の療法を実現しようとしているということもできるかもしれません。

また、Nostrと違って秘密鍵や公開鍵が表に出てきません。API利用する際にもユーザー名とパスワードを使ってアクセスすることになります。

もちろんPDSの責任で投稿を削除できますし、画像の投稿もできますし、パスワードを忘れても大丈夫です。Nostrほどリテラシーが必要ありません。
もちろんPDSの責任でスパム対策もできますし、凍結やBANも発生します。

# アプリを作るには
投稿やフォロー、リポスト、タイムラインの取得などは以下を参照してください。

https://atproto.com/guides/applications

# データ保持

```
最後に誰がデータ保持の責任を持てるのか？
Twitterは管理者が持つ。
ActivityPubは各インスタンスの管理者が持つ。
Nostrは多分誰も持たないことにした。
ATProtocolは最後にユーザーに持たせることにした。
```
